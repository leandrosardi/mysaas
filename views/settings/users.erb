<!--#include virtual = "./lgi/commons.asp"-->

<%
login = @login
user = BlackStack::User.where(:id=>login.id_user).first
c = BlackStack::Client.where(:id=>user.id_client).first

username = session['member.users.username'].to_s 
email = session['member.users.email'].to_s
phone = session['member.users.phone'].to_s
%>

	<!-- Page content
		================================================== -->
	<div class="mynavbar mysticky">
		<section class="row-fluid">	
			<div class='span6'>
				<%=nav2("Settings", "/settings/dashboard", "Users")%>
			</div>
			<div class='span6' align='right' style='text-align: right;alignment-adjust: right; margin-left: 0;'>
				<button id='save' name='save' class="btn btn-blue btn-medium" type="button" title='Save Changes On Selected Users'>
					<i class="icon-ok"></i>
					Save
				</button>
			</div>
		</section>
	</div>
	<section class="container">

		<br/>
		
		<section class="row-fluid">
			<div class="form-horizontal span12 box" style="margin-bottom: 20px">

				<input type='hidden' name='uid' id='uid' value='<%=user.id.gsub("{", "").gsub("}", "")%>'>
				<table class="table table-striped" style='table-layout: fixed; width: 100%;'>
					<thead>
							<th style='text-align: center; width:15px' >
								<input class="checkbox" id="checkAll" type="checkbox">
							</th>
							<th style ='width:36px;'>
								<!-- picture -->
							</th>
							<th style ='width:auto;'>
								Name
							</th>
							<th style ='width:175px;'>
								Email
							</th>
							<th style ='width:175px;'>
								Phone
							</th>
							<th valign='middle' style='text-align: left; width:175px;'>
								Linkedin url
							</th>
							<th valign='middle' align"center" style='text-align: center; width:50px;'>
								LTL <i class='icon-question-sign' title='The user is allowed to Leads Transfer through LinkedIn'></i>
							</th>
							<th style='width:50px;'>
								Verified
							</th>
						</tr>
					</thead>

					<tbody>
						<%
						users = BlackStack::User.where(:id_client=>c.id).filter('delete_time is null').order(:name).all
						users.each { |u|
						%>
						<tr>
							<td style='text-align: center; vertical-align: middle;'>
								<input class="checkbox select-row" type="checkbox" id="<%=u.id.to_guid%>" data-id="<%=u.id.to_guid%>">
							</td>
							<td>
								<a href='/settings/user/<%=u.id.to_guid%>'><img class='avatar' src="<%="https://www.gravatar.com/avatar/" + Digest::MD5.hexdigest(u.email.strip.downcase)%>" alt="<%=u.name.gsub('"', '&#34;')%>" title="<%=u.name.gsub('"', '&#34;')%>"></a>
							</td>
							<td style='position:relative;'>
								<input onFocus="this.select();" class='user-input' type='text' value='<%=u.name.to_s.encode_html%>' style='width:100%'>
								<%
								if (u.email.to_s==user.email.to_s && session['login.id_prisma_user'].to_s.size == 0)
								%>
									<span class="label label-info" style='position:absolute;right:0px;top:5px;'>you</span>
								<%
								elsif u.id.to_guid != c.id_user_to_contact.to_s.to_guid
									if users.size > 1
									%>
										<button class='btn btn-mini btn-red' style='position:absolute;right:0px;top:7px;' onclick="window.location='/settings/filter_delete_user?uid=<%=u.id.to_guid%>'">delete</button>
									<%
									else
									%>
										<span class='btn-small' style='color:gray;'>delete</span>
									<%
									end
								end
								%>

								<%
								if u.id.to_guid == c.id_user_to_contact.to_s.to_guid
								%>
									<span class="label label-green">contact user</span>
									<a href='/settings/clientinformation' class='btn-small'>change contact user</a>
								<%
								end
								%>
							</td>
							
							<td data-id="<%=u.id.to_guid%>" class='email' style='overflow: hidden; white-space: nowrap;text-overflow: ellipsis; vertical-align: middle;'>
								<%=getEmailToShow(u).encode_html%>
							</td>

							<td data-id="<%=u.id.to_guid%>" class='phone' style='overflow: hidden; white-space: nowrap;text-overflow: ellipsis; vertical-align: middle;'>
								<input onFocus="this.select();" class='phone-input' type='text' value='<%=u.phone.to_s.encode_html%>' style='width:100%'>
							</td>

							<td data-id="<%=u.id.to_guid%>" class='linkedinUrl' style='overflow: hidden; white-space: nowrap;text-overflow: ellipsis; vertical-align: middle;'>
								<input onFocus="this.select();" class='linkedinUrl-input' style='width:95%' type='text' value='<%=u.linkedin_profile_url.to_s.encode_html%>'>
							</td>

							<td style='text-align: center; vertical-align: middle;'>
								<%
								if (u.allowed_for_linkedin_group_chat_transfers == true)
								%>
									<input class="checkbox gtc" type="checkbox" data-id="<%=u.id.to_guid%>" checked>
								<%
								else
								%>							
									<input class="checkbox gtc" type="checkbox" data-id="<%=u.id.to_guid%>">
								<%
								end
								%>
							</td>
							
							<td style='vertical-align: middle; text-align:center;'>
								<%
								if (u.verified == true)
								%>
									<span class="label label-green">verified</span>
								<%
								else
								%>		
									<button class='btn btn-link resend' data-uid='<%=u.id.to_guid%>'>request</button>
								<%
								end
								%>								
							</td>

							<td style='vertical-align: middle; text-align:center;'>
								<a class='simple' href='/settings/user/<%=u.id.to_guid%>'>view</a>
							</td>
						</tr>
						<%
						}
						%>

						<form method='get' action='/settings/filter_add_user'>
						<input type='hidden' id='cid' name='cid' value='<%=c.id%>'>
						<tr>
							<td>
							</td>

							<td>
							</td>

							<td>
								<input onFocus="this.select();" type='text' class='input-block-level' id='username' name='username' value='<%=username.encode_html%>' tabindex="1" onfocus="$(this).select();" style="width:100%" />
							</td>
							<td>
								<input onFocus="this.select();" type='text' class='input-block-level' id='email' name='email' value='<%=email.encode_html%>' tabindex="2" onfocus="$(this).select();" />
							</td>
							<td>
								<input type='submit' class='btn btn-primary btn-blue' id='add' name='add' value='add' tabindex="4" />
							</td>

						</tr>
						</form>						
					</tbody>
				</table>

			</div>

		</section>
	</section>


<script type="text/javascript">
	$( document ).ready(function() {
	    document.getElementById("username").focus();
	});

	// Check All checkbox
	$('#checkAll').click(function () {    
    	$('.select-row').prop('checked', this.checked);    
 	});

	// Check all row checkbox after a change
	$(".gtc").change(function(){
		$next = $(this).closest('tr').find('.select-row');
		$next.prop('checked', 'checked');
	})

	$(".user-input").on('input', function(){
		$next = $(this).closest('tr').find('.select-row');
		$next.prop('checked', 'checked');
	})

	$(".phone-input").on('input', function(){
		$next = $(this).closest('tr').find('.select-row');
		$next.prop('checked', 'checked');
	})

	$(".linkedinUrl-input").on('input', function(){
		$next = $(this).closest('tr').find('.select-row');
		$next.prop('checked', 'checked');
	})

	// top bar button: save changes
	$('#save').click(function() {
		s = '';
		$(".select-row:checked").each(function () {
			id = $(this).data('id');
			user = $(this).closest('tr').find('.user-input').val().toString();
			phone = $(this).closest('tr').find(".phone-input").val().toString();
			linkedin_url = $(this).closest('tr').find(".linkedinUrl-input").val().toString().replace('https://', '');
			gtc = $(".gtc[data-id='"+id+"']").is(":checked").toString();
			s += 'uid[]='+id+':'+user+':'+phone+':'+linkedin_url+':'+gtc+'&'
		});
		console.log(s)
		window.location = '/settings/filter_update_user?'+s;
	});

	$(".resend").click(function() {
		<%
		if c.resellerSignature?
		%>
			alert('Sending confirmation emails is not allowed when you have activated a reseller signature.');
		<%
		else
		%>
			o = $(this);
			
			xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					res = JSON.parse(this.responseText);
					if (res.status == "success") {
						o.text("sent!");
					} else {
						o.text("error!");
						alert(res.status);
					}
				}
			};
			
			// deshabilito el link
			o.text("sending...")
			
			// envio el ajax
			xhttp.open("GET", "/api1.2/division/send_confirmation_email.json?api_key=<%=BlackStack::Pampa::api_key.to_s%>&uid="+o.data("uid"), true);
			xhttp.send();
		<%
		end
		%>		
	});
	
</script>
